<!doctype html>
<meta charset="utf-8">
<title>miniWebRTC</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<h3>Create or join a room?</h3>
<input type="text" name="user" id="user" placeholder="e.g. Alice">
<button type="submit" id="setid">Connect to WebSocket</button>
<input type="text" id="user2" placeholder="e.g. Bob">
<button id="connectToRemote">Connect to remote</button>
<br>
Chat:
<br>
<div id="chatlog" style="height:200px; overflow:auto; border:1px solid"></div>
<br>
<input type="text" id="messageTextBox" placeholder="Type your message here">
<button id="sendMessageBtn" onclick="sendMessage()">Send message</button>
<script src="/socket.io/socket.io.js"></script>
<script>
    
    var user = null;
    var user2 = null;
    var socket = null;
    var pcLocal ;
    var pcLocalList = {};
    var dcList = {};
    dc1 = null;
    dc2 = null;
    pc2icedone = false;
    tn1 = null;
   var activedc;
    var currentSocketId;



 /*   var cfg = {
                'iceServers': [
                    {
                        'url': 'stun:stun.l.google.com:19302'
                    },
                    {
                        'url': 'turn:192.158.29.39:3478?transport=udp',
                        'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
                        'username': '28224511:1379330808'
                    },
                    {
                        'url': 'turn:192.158.29.39:3478?transport=tcp',
                        'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
                        'username': '28224511:1379330808'
                    }
                ]
            },*/
    var cfg = {'iceServers': [{'url': "stun:stun.l.google.com:19302"}]},
            con = {'optional': [{'DtlsSrtpKeyAgreement': true}]};

    var sdpConstraints = {
        optional: [],
    }



    function connectToWebSocket() {
        socket = io.connect(location.origin);



        socket.on('welcomeMessage', function (message) {
            console.log("received message from the server : " + message);
        });
        socket.on('askForId', function (id) {
            pcLocalList[createID(user,user2)] = pcLocal;
            if (dc1!=null){
                dcList[createID(user,user2)] = dc1;
            }
            if (dc2!=null){
                dcList[createID(user,user2)] = dc2;
            }


        });
        socket.on('listOfClient', function (list) {
           updateList(list);
        });
        socket.on('negotiationMessage', function (data) {
            console.log("received message from the server : " + data);
     //       var json = JSON.parse(data);

            if (data.action == "offer") {
                // incoming offer
                //  if(json.to == user){
                user2 = data.from;
                processOffer(data.data)
                // }
            } else if (data.action == "answer") {
                // incoming answer
                if (data.to == user) {
                    processAnswer(data.data , data.id);
                }
            }
        });

        socket.emit('nouveau_client', user);

/*
        socket.on('nouveau_client', function (pseudo) {
            var el = document.createElement("p");
            var txtNode = document.createTextNode(pseudo + ' vient de se connecter');
            el.appendChild(txtNode);
            receivebox.appendChild(el);
        });
*/

        /*    var HOST = location.origin.replace(/^http/, 'ws')
            ws = new WebSocket(HOST);
            // ws = new WebSocket("ws://pocwebrtc.herokuapp.com:5001");
            ws.onopen = function (e) {
                console.log("Websocket opened");
                var msg = {
                    type: "username",
                    data: user,
                    test: e
                };
                ws.send(JSON.stringify(msg));
            }
            ws.onclose = function (e) {
                console.log("Websocket closed");
            }

            ws.onmessage = function (e) {
                console.log("Websocket message received: " + e.data);
                var json = JSON.parse(e.data);

                if (json.action == "candidate") {
                    if (json.to == user) {
                        processIce(json.data);
                    }
                } else if (json.action == "offer") {
                    // incoming offer
                    //  if(json.to == user){
                    user2 = json.from;
                    processOffer(json.data)
                    // }
                } else if (json.action == "answer") {
                    // incoming answer
                    if (json.to == user) {
                        processAnswer(json.data);
                    }
                }
                // else if(json.action == "id"){
                //    userId = json.data;
                // } else if(json.action=="newUser"){
                //     if(userId!=null && json.data!=userId){

                //     }
                // }

            }
            ws.onerror = function (e) {
                console.log("Websocket error");
            }*/
    }


    // BOB: create
    function connectTo() {
         pcLocal =  new RTCPeerConnection(cfg, con);
       //pcLocal = new RTCPeerConnection(cfg, con);

        pcLocal.onicecandidate = function (e) {
            if (pcLocal.iceGatheringState == "complete") {
                sendNegotiation("offer", pcLocal.localDescription);
            }
            else {
                /*     console.log("CONNECTED");
                 var data = {user: "system", message: "user '" + user + "' connected"};
                 writeMsg(data);
                 activedc.send(JSON.stringify(data));
                 */
            }
        }


        dc1 = pcLocal.createDataChannel(createID(user,user2), {reliable: true})
        activedc = dc1
        dc1.onopen = function (e) {
            console.log('Connected');
            var data = {user: "system", message: "the datachannel "+dc1.label+" has been opened"};
            writeMsg(data);
      //      activedc.send(JSON.stringify(data));
        }
        dc1.onmessage = function (e) {

            if (e.data.charCodeAt(0) == 2) {
                return
            }
            var data = JSON.parse(e.data);
            writeMsg(data);
        }
        pcLocal.createOffer(function (desc) {
            pcLocal.setLocalDescription(desc, function () {}, function () {});
            console.log("------ SEND OFFER ------");

        }, function () {}, sdpConstraints)

        pcLocalList[createID(user,user2)] = pcLocal;
        if (dc1!=null){
            dcList[createID(user,user2)] = dc1;
        }
    }
    ;

    function createID(local,remote){
        return local+'-'+remote;
    }
    // BOB: pasted Alice's answer
    function processAnswer(answer,id) {
        var answerDesc = new RTCSessionDescription(answer);
        pcLocalList[createID(user,user2)].setRemoteDescription(answerDesc);
        console.log("------ PROCESSED ANSWER ------");
        return true;
    }
    ;

    function updateList(list) {
        var x = document.getElementById("liste");
        list.forEach(function(entry) {
            var c = document.createElement("option");
            c.text = entry.id;
            x.options.add(c);
        });
    }

    setid.onclick = function () {
        user = $("#user").val();
        connectToWebSocket();
        return false;
    };
    connectToRemote.onclick = function () {
        user2 = $("#user2").val();
        connectTo();
    }

    // ALICE: pasted Bob's answer
    function processOffer(offer) {
        var pcRemote = new RTCPeerConnection(cfg, con)

        pcRemote.ondatachannel = function (e) {
            var datachannel = e.channel || e;
            dc2 = datachannel;
            activedc = dc2;
            dc2.onopen = function (e) {
                console.log('Connected');
                //on écrit dans le chat que le user s'est connecté
                var data = {user: "system", message: "the datachannel "+dc2.label+" has been opened"};
                writeMsg(data);
                //on envoie dans le channel que le user s'est connecté
           //     activedc.send(JSON.stringify(data));
                socket.emit("askForId", user2);
            };
            dc2.onmessage = function (e) {
                var data = JSON.parse(e.data);
                writeMsg(data);
            }
        };

        pcRemote.onicecandidate = function (e) {
            if (e.candidate != null) {
                sendNegotiation("answer", pcRemote.localDescription);
                //  sendNegotiation("candidate", e.candidate);
            }
            else {/*
             console.log("CONNECTED");
             //on écrit dans le chat que le user s'est connecté
             var data = {user: "system", message: "user '" + user + "' connected"};
             writeMsg(data);
             //on envoie dans le channel que le user s'est connecté
             activedc.send(JSON.stringify(data));
             */
            }
        }

        pcLocalList[createID(user,user2)] = pcRemote;
        if (dc2!=null){
            dcList[createID(user,user2)] = dc2;
        }

        var offerDesc = new RTCSessionDescription(offer);
        var sdpConstraints = {
            'mandatory': {
                'OfferToReceiveAudio': false,
                'OfferToReceiveVideo': false
            }
        };
        pcRemote.setRemoteDescription(offerDesc);
        pcRemote.createAnswer(function (answerDesc) {
                    pcRemote.setLocalDescription(answerDesc);
                    console.log("------ SEND ANSWER ------");
                },
                function () {
                },
                sdpConstraints)
    }

    if (navigator.webkitGetUserMedia) {
        RTCPeerConnection = webkitRTCPeerConnection
    }



    function sendMessage() {
        if (messageTextBox.value) {
            for (var id in dcList) {
                dcList[id].send(JSON.stringify({message: messageTextBox.value, user: user}));
            }
           // activedc.send(JSON.stringify({message: messageTextBox.value, user: user}));
            chatlog.innerHTML += '[' + user + '] ' + messageTextBox.value + '</p>';
            messageTextBox.value = "";
        }
        return false
    }

    function sendNegotiation(type, sdp) {
        var json = {from: user, to: user2, action: type, data: sdp};
        console.log("Sending [" + user + "] to [" + user2 + "]: " + JSON.stringify(sdp));
        socket.emit("negotiationMessage", JSON.stringify(json));
    }



    /*
     pc1.onicecandidate = e => !e.candidate
     || sendNegotiation("candidate", e.candidate);
     */

    function writeMsg(data) {
        chatlog.innerHTML += '[' + data.user + '] ' + data.message + '</p>';
        chatlog.scrollTop = chatlog.scrollHeight;
    }

    /*
     pc2.onicecandidate = e => !e.candidate
     || sendNegotiation("candidate", e.candidate)
     */
</script>